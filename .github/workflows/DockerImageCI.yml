name: CI

on:
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: windows-2019
    steps:
      - uses: actions/checkout@v1    
      - name: Install NavContainerHelper
        run: Install-Module NavContainerHelper -Force
        shell: powershell
      - name: Set up Business Central container
        env:
          USERNAME: ${{ secrets.USERNAME }}
          PASSWORD: ${{ secrets.PASSWORD }}
        run: >
          New-BCContainer 
          -accept_eula 
          -containerName bcdev 
          -imageName mcr.microsoft.com/businesscentral/onprem:latest 
          -useBestContainerOS 
          -alwaysPull 
          -auth NavUserPassword 
          -credential ([PSCredential]::new($Env:USERNAME, (ConvertTo-SecureString -String $Env:PASSWORD -AsPlainText -Force))) 
          -updateHosts
          -additionalParameters @("--volume $Env:GITHUB_WORKSPACE\Modules\System`:c:\project")
          -includeAL
        shell: powershell
      - name: Compile extension
        env:
          USERNAME: ${{ secrets.USERNAME }}
          PASSWORD: ${{ secrets.PASSWORD }}    
        run: >
          $Content = '<?xml version="1.0" encoding="utf-8"?>'
          $Content += '<configuration>'
          $Content += '  <packageSources>'
          $Content += '    <add key="Dynamics NAV nuget feed" value="https://dynamicssmb2.pkgs.visualstudio.com/_packaging/DynamicsSMBPackages/nuget/v3/index.json" protocolVersion="3" />'
          $Content += '  </packageSources>'
          $Content += '  <packageSourceCredentials>'
          $Content += '    <Dynamics_NAV_nuget_feed>'
          $Content += '        <add key="Username" value="$USERNAME" />'
          $Content += '        <add key="Password" value="$PASSWORD" />'
          $Content += '    </Dynamics_NAV_nuget_feed>'
          $Content += '   </packageSourceCredentials>'
          $Content += '   <packageRestore>'
          $Content += '        <add key="enabled" value="True" />'
          $Content += '    </packageRestore>'
          $Content += '</configuration>'
          Set-Content config $Content
          docker cp config bcdev:/config
          docker exec -it bcdev $Env:GITHUB_WORKSPACE\CI\dockerscript.ps1
        shell: powershell